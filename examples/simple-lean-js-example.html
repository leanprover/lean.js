<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
  </head>
  <body>
<p>Small example of using lean.js, by Nathan Carter, 7/31/15.<br>
Using information learned from Soonho Kong's Lean Tutorial app.<br>
<b>Output appears only on the JavaScript console; look there.</b></p>

<script type="text/javascript" charset="utf-8">
/*
 * Utilities for timing things.
 */
var myTimer = null;
function now () { return (new Date()).getTime(); }
function startTimer () { myTimer = now(); }
function checkTimer () { return '(took ' + (now() - myTimer) + 'ms)'; }

/*
 * "Module" must be initialized before the <script> tag for lean.js.
 * The lean.js script populates Module with compiled Lean code,
 * but it needs to know about the parameters below or it will throw errors.
 */
console.log( '-------------------------------------------' );
console.log( '---------------- S E T U P ----------------' );
console.log( '-------------------------------------------' );
console.log( '--- Loading Lean VM...' ); startTimer();
Module = { };
Module.TOTAL_MEMORY = 64 * 1024 * 1024;
Module.noExitRuntime = true;
var myLeanOutputTracker = null;
Module.print = function ( text ) {
    var match = null;
    if ( match = /FLYCHECK_BEGIN (.*)/.exec( text ) ) {
        myLeanOutputTracker = { type : match[1], text : [ ] };
    } else if ( !myLeanOutputTracker ) {
        throw new Error( 'Unexpected output from Lean: ' + text );
    } else if ( match = /([^:]+):(\d+):(\d+): (.*)/.exec( text ) ) {
        myLeanOutputTracker.file = match[1];
        myLeanOutputTracker.line = match[2];
        myLeanOutputTracker.char = match[3];
        myLeanOutputTracker.info = match[4];
    } else if ( /FLYCHECK_END/.test( text ) ) {
        console.log( 'Lean output: '
                   + JSON.stringify( myLeanOutputTracker, null, 4 ) );
        myLeanOutputTracker = null;
    } else {
        myLeanOutputTracker.text.push( text );
    }
}
Module.preRun = [
    function () {
        console.log( '--- Lean VM loaded.', checkTimer() );
        console.log( '--- Running Lean VM...' ); startTimer();
    }
];
Module.postRun = function () {
    console.log( '--- Lean VM has been run.', checkTimer() );
}
</script>

<!-- Import the Lean JavaScript module generated by emscripten. -->
<script src="https://leanprover.github.io/lean.js/lean.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
/*
 * Initialize the lean.js module.
 */
console.log( '--- Calling lean_init()...' ); startTimer();
Module.lean_init( false ); // or use true for HoTT support
console.log( '--- lean_init() complete.', checkTimer() );
/*
 * Import the Lean standard module.
 */
console.log( '--- Importing Lean standard module...' ); startTimer();
Module.lean_import_module( "standard" );
console.log( '--- Standard module imported.', checkTimer() );

/*
 * Save an example .lean file into the virtual filesystem.
 */
console.log( '-------------------------------------------' );
console.log( '-------------- R U N N I N G --------------' );
console.log( '-------------------------------------------' );
console.log( '--- Writing test.lean to virtual FS...' ); startTimer();
testfile = 'variables p q r s : Prop\n'
         + 'theorem and_comm : p ∧ q ↔ q ∧ p :=\n'
         + 'iff.intro\n'
         + '  (assume Hpq : p ∧ q,\n'
         + '    and.intro (and.elim_right Hpq) (and.elim_left Hpq))\n'
         + '  (assume Hqp : q ∧ p,\n'
         + '    and.intro (and.elim_right Hqp) (and.elim_left Hqp))\n'
         + 'print "end of file!"\n';
console.log( testfile );
FS.writeFile( 'test.lean', testfile, { encoding: 'utf8' } );
console.log( '--- test.lean written.', checkTimer() );
/*
 * Run Lean on the above file.
 */
console.log( '--- Running Lean on test.lean...' ); startTimer();
Module.lean_process_file( 'test.lean' );
console.log( '--- Lean has been run on test.lean.', checkTimer() );
</script>
</body>
</html>
